<!DOCTYPE html>
<html>
<head>
<title>Photos</title>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css" />
<style>
.photo { background-color: black; background-repeat: no-repeat; background-position: center; background-size: auto 100%; }
.photo.ui-page .ui-footer { position: fixed; bottom: 0; opacity: 0.5; }
.photo .ui-footer .ui-btn-left { float: left; margin: 0.2em; }
</style>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.5.2.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.js"></script>
<script type="text/javascript">

$(function() {
    var users = ['sparkleysprout', 'jollytoad'],
        photos = JSON.parse(localStorage.getItem("photos") || "[]"),
        albums = JSON.parse(localStorage.getItem("albums") || "[]"),
        albumCount = 0,
        img = document.getElementById("photo"),
        head = document.getElementsByTagName("head")[0],
        photoTimeout;

    function addAlbumItem(album, n) {
        var ul = $("#albumlist"),
            li = $("<li/>"),
            count = $('<span class="ui-li-count"/>').text(album.count);
        $('<a href="#album?album='+n+'"/>').text(album.title+" ").append(count).appendTo(li);
        ul.append(li);
        if (ul.data("listview")) {
            ul.listview("refresh");
        }
    }

    function msg(text) {
        $(".msg").text(text);
    }

    function picasaGetAlbumsForUser(user, userIndex) {
        msg("Loading albums for: " + user);
        $.ajax({
            url: "http://picasaweb.google.com/data/feed/api/user/" + user,
            data: "alt=json-in-script&v=2&fields=title,entry(title,gphoto:*,media:*(media:thumbnail))",
            dataType: "jsonp",
            success: function(data) {
                data.feed.entry.forEach(function(entry) {
                    var album = {
                            id: entry.gphoto$id.$t,
                            title: entry.title.$t,
                            icon: entry.media$group.media$thumbnail,
                            user: userIndex,
                            count: entry.gphoto$numphotos.$t
                        },
                        albumIndex = albums.length;
                    albums.push(album);
                    addAlbumItem(album, albumIndex, albums);

                    setTimeout(function() {
                        picasaGetPhotosFromAlbum(album, albumIndex, albums);
                    }, 100);
                });
                localStorage.setItem("albums", JSON.stringify(albums));
            }
        });

    }

    function picasaGetPhotosFromAlbum(album, albumIndex) {
        var user = users[album.user];
        msg("Loading album: " + album.title + " from " + user);
        $.ajax({
            url: "http://picasaweb.google.com/data/feed/api/user/" + user + "/albumid/" + album.id,
            data: "alt=json-in-script&v=2&fields=entry(gphoto:id)",
            dataType: "jsonp",
            success: function(data) {
                album.first = photos.length;
                data.feed.entry.forEach(function(entry) {
                    photos.push({
                        id: entry.gphoto$id.$t,
                        a: albumIndex
                    });
                });
                album.last = photos.length - 1;
                localStorage.setItem("photos", JSON.stringify(photos));
            }
        });
    }

    function setRandomPhoto() {
        var i = Math.floor(Math.random()*photos.length),
            photo = photos[i],
            album = photo && albums[photo.a],
            user = album && users[album.user],
            page = $(this);

        if (photo && album) {
            $.ajax({
                url: "http://picasaweb.google.com/data/entry/api/user/" + user + "/albumid/" + album.id + "/photoid/" + photo.id,
                dataType: "jsonp",
                data: "alt=json-in-script&v=2&fields=media:*",
                success: function(data) {
                    var url = data.entry.media$group.media$content[0].url;
                    console.log(url, data);
                    page.css("background-image", "url(" + url + ")");
                    page.find(".album-title").text(album.title);
                }
            });
        }
    }

	function loadPhotoData() {
	    msg("Loading...");
	    albums = [];
		photos = [];
    	users.forEach(picasaGetAlbumsForUser);
	}

    $(".photo")
        .live("pagehide", function() {
            setRandomPhoto.apply(this);
        })
        .live("pageshow", function() {
            photoTimeout = setTimeout(function() {
                var next = $.mobile.activePage.next(".photo");
                if (!next.length) {
                    next = $("#photo-0");
                }
                $.mobile.changePage(next[0].id, "fade");
            }, 5000);
        });

    $("#home").live("pagebeforeshow", function() {
    	clearTimeout(photoTimeout);
    });

    function startSlideshow(delay1, delay2) {
		setTimeout(function() {
		    $(".photo").each(setRandomPhoto);
		}, 1000);

		setTimeout(function() {
		    $.mobile.changePage("photo-0", "slide");
		}, 4000);
	}

    if (!photos || photos.length === 0) {
    	loadPhotoData();
        startSlideshow(1000,4000);
	} else {
        albums.forEach(addAlbumItem);
	    startSlideshow(0,2000);
	}
});

</script>
</head> 
<body> 

<div data-role="page" id="home">
	<div data-role="header" data-theme="b">
		<h1>Photoframe</h1>
		<a href="#photo-0" data-role="button" data-icon="arrow-r" data-iconpos="right" class="ui-btn-right">Slideshow</a>
	</div>

	<div data-role="content">
        <h2>Configuration</h2>
        <ul data-role="listview" data-inset="true">
            <li><a href="#origins">Origins</a></li>
            <li><a href="#albums">Albums</a></li>
        </ul>
	</div>

    <div data-role="footer">
        <h4 class="msg"></h4>
    </div>
</div>

<div data-role="page" id="origins">
    <div data-role="header" data-theme="b">
        <a href="#home" data-role="button" data-icon="home">Home</a>
        <h1>Origins</h1>
        <a href="#photo-0" data-role="button" data-icon="arrow-r" data-iconpos="right" class="ui-btn-right">Slideshow</a>
    </div>

    <div data-role="content">
    </div>
</div>

<div data-role="page" id="albums">
	<div data-role="header" data-theme="b">
        <a href="#home" data-role="button" data-icon="home">Home</a>
		<h1>Photo Albums</h1>
		<a href="#photo-0" data-role="button" data-icon="arrow-r" data-iconpos="right" class="ui-btn-right">Slideshow</a>
	</div>

	<div data-role="content">
        <ul id="albumlist" data-role="listview"></ul>
	</div>

    <div data-role="footer">
        <h4 class="msg"></h4>
    </div>
</div>

<div data-role="page" id="photo-0" class="photo">
    <div data-role="footer">
        <a href="#home" data-role="button" data-icon="home">Home</a>
        <h4 class="album-title"></h4>
    </div>
</div>
<div data-role="page" id="photo-1" class="photo">
    <div data-role="footer">
        <a href="#home" data-role="button" data-icon="home">Home</a>
        <h4 class="album-title"></h4>
    </div>
</div>

</body>
</html>
