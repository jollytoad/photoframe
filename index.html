<!DOCTYPE html>
<html>
<head>
<title>Photos</title>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css" />
<style>
.photo { background-color: black; background-repeat: no-repeat; background-position: center; background-size: auto 100%; }
.photo.ui-page .ui-footer { position: fixed; bottom: 0; opacity: 0.5; }
.photo .ui-footer .ui-btn-left { float: left; margin: 0.2em; }
</style>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.5.2.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.js"></script>
<script type="text/javascript">

$(function() {
    var sites = {},
        origins = JSON.parse(localStorage.getItem("origins") || "[]"),
        defaultOrigins = [
            { site: "picasa", username: "sparkleysprout" },
            { site: "picasa", username: "jollytoad" }
        ],
        photos = JSON.parse(localStorage.getItem("photos") || "[]"),
        albums = JSON.parse(localStorage.getItem("albums") || "[]"),
        albumCount = 0,
        img = document.getElementById("photo"),
        head = document.getElementsByTagName("head")[0],
        photoTimeout;

    function addListItem(list, opts) {
        var o = opts || {},
            ul = $(list),
            li = $("<li/>").appendTo(ul),
            a = $("<a/>", { href: "#" }).appendTo(li);

        if (o.href) {
            $("<a/>", { href: o.href }).appendTo(li);
        }

        if (o.icon) {
            li.addClass("ui-li-has-thumb");
            $('<img/>', { src: o.icon, className: "ui-li-thumb" }).prependTo(a);
        }
        if (o.title) {
            $('<h3/>', { text: o.title }).appendTo(a);
        }
        if (o.desc) {
            $('<p/>', { text: o.desc }).appendTo(a);
        }
        if (o.count !== undefined) {
//            $('<span class="ui-li-count"/>').text(o.count).appendTo(a);
        }

        if (ul.data("listview")) {
            ul.listview("refresh");
        }

    }
    function addAlbumItem(album, albumIndex) {
        addListItem("#albumlist", { href: album.link, title: album.title, count: album.count, icon: album.icon, desc: origins[album.origin].title });
    }

    function addOriginItem(origin, originIndex) {
        addListItem("#originlist-" + origin.site, { href: origin.link, title: origin.title });
    }

    function msg(text) {
        $(".msg").text(text);
    }

    function picasaGetAlbumsForUser(origin, originIndex) {
        msg("Loading albums for: " + origin.username);
        $.ajax({
            url: "http://picasaweb.google.com/data/feed/api/user/" + origin.username,
            data: "alt=json-in-script&v=2&fields=gphoto:*,entry(title,gphoto:*,media:*(media:thumbnail),link[@rel='alternate'])",
            dataType: "jsonp",
            success: function(data) {
                origin.title = data.feed.gphoto$nickname.$t;
                addOriginItem(origin, originIndex);
                data.feed.entry.forEach(function(entry) {
                    console.log(entry);
                    var album = {
                            id: entry.gphoto$id.$t,
                            title: entry.title.$t,
                            icon: entry.media$group.media$thumbnail[0].url,
                            origin: originIndex,
                            count: entry.gphoto$numphotos.$t,
                            link: entry.link[0].href
                        },
                        albumIndex = albums.length;
                    albums.push(album);
                    addAlbumItem(album, albumIndex);

                    setTimeout(function() {
                        picasaGetPhotosFromAlbum(album, albumIndex);
                    }, 100);
                });
                localStorage.setItem("origins", JSON.stringify(origins));
                localStorage.setItem("albums", JSON.stringify(albums));
            }
        });
    }

    function picasaGetPhotosFromAlbum(album, albumIndex) {
        var origin = origins[album.origin];
        msg("Loading album: " + album.title + " from " + (origin.title || origin.username));
        $.ajax({
            url: "http://picasaweb.google.com/data/feed/api/user/" + origin.username + "/albumid/" + album.id,
            data: "alt=json-in-script&v=2&fields=entry(gphoto:id)",
            dataType: "jsonp",
            success: function(data) {
                album.first = photos.length;
                data.feed.entry.forEach(function(entry) {
                    photos.push({
                        id: entry.gphoto$id.$t,
                        a: albumIndex
                    });
                });
                album.last = photos.length - 1;
                localStorage.setItem("photos", JSON.stringify(photos));
            }
        });
    }

    function picasaGetPhoto(origin, album, photo, callback) {
        $.ajax({
            url: "http://picasaweb.google.com/data/entry/api/user/" + origin.username + "/albumid/" + album.id + "/photoid/" + photo.id,
            dataType: "jsonp",
            data: "alt=json-in-script&v=2&fields=media:*",
            success: function(data) {
                callback({
                    url: data.entry.media$group.media$content[0].url
                });
            }
        });
    }

    sites.picasa = {
        loadOrigin: picasaGetAlbumsForUser,
        loadPhoto: picasaGetPhoto
    };

    function setRandomPhoto() {
        var i = Math.floor(Math.random()*photos.length),
            photo = photos[i],
            album = photo && albums[photo.a],
            origin = album && origins[album.origin],
            site = origin && sites[origin.site],
            page = $(this);

        if (site && site.loadPhoto) {
            site.loadPhoto(origin, album, photo, function(data) {
                console.log(data.url);
                page.css("background-image", "url(" + data.url + ")");
                page.find(".album-title").text(album.title);
            });
        }
    }

	function loadPhotoData() {
	    msg("Loading...");
	    albums = [];
		photos = [];
    	origins.forEach(function(origin, originIndex) {
            var site = sites[origin.site];
            if (site && site.loadOrigin) {
                site.loadOrigin(origin, originIndex);
            }
        });
	}

    $(".photo")
        .live("pagehide", function() {
            setRandomPhoto.apply(this);
        })
        .live("pageshow", function() {
            photoTimeout = setTimeout(function() {
                var next = $.mobile.activePage.next(".photo");
                if (!next.length) {
                    next = $("#photo-0");
                }
                $.mobile.changePage(next[0].id, "fade");
            }, 5000);
        });

    $("#home").live("pagebeforeshow", function() {
    	clearTimeout(photoTimeout);
    });

    function startSlideshow(delay1, delay2) {
		setTimeout(function() {
		    $(".photo").each(setRandomPhoto);
		}, 1000);

		setTimeout(function() {
		    $.mobile.changePage("photo-0", "slide");
		}, 4000);
	}

    if (!origins || !origins.length) {
        origins = defaultOrigins;
    	loadPhotoData();
        if (!location.hash) {
            startSlideshow(1000,4000);
        }
	} else {
        origins.forEach(addOriginItem);
        albums.forEach(addAlbumItem);
        if (!location.hash) {
    	    startSlideshow(0,2000);
        }
	}
});

</script>
</head> 
<body> 

<div data-role="page" id="home">
	<div data-role="header" data-theme="b">
		<h1>Photoframe</h1>
		<a href="#photo-0" data-role="button" data-icon="arrow-r" data-iconpos="right" class="ui-btn-right">Slideshow</a>
	</div>

	<div data-role="content">
        <h2>Configuration</h2>
        <ul data-role="listview" data-inset="true">
            <li><a href="#origins">Origins</a></li>
            <li><a href="#albums">Albums</a></li>
        </ul>
	</div>

    <div data-role="footer">
        <h4 class="msg"></h4>
    </div>
</div>

<div data-role="page" id="origins">
    <div data-role="header" data-theme="b">
        <a href="#home" data-role="button" data-icon="home">Home</a>
        <h1>Origins</h1>
        <a href="#photo-0" data-role="button" data-icon="arrow-r" data-iconpos="right" class="ui-btn-right">Slideshow</a>
    </div>

    <div data-role="content">
        <h2>Picasa Accounts</h2>
        <ul id="originlist-picasa" data-role="listview" data-inset="true"></ul>
    </div>
</div>

<div data-role="page" id="albums">
	<div data-role="header" data-theme="b">
        <a href="#home" data-role="button" data-icon="home">Home</a>
		<h1>Photo Albums</h1>
		<a href="#photo-0" data-role="button" data-icon="arrow-r" data-iconpos="right" class="ui-btn-right">Slideshow</a>
	</div>

	<div data-role="content">
        <ul id="albumlist" data-role="listview"></ul>
	</div>

    <div data-role="footer">
        <h4 class="msg"></h4>
    </div>
</div>

<div data-role="page" id="photo-0" class="photo">
    <div data-role="footer">
        <a href="#home" data-role="button" data-icon="home">Home</a>
        <h4 class="album-title"></h4>
    </div>
</div>
<div data-role="page" id="photo-1" class="photo">
    <div data-role="footer">
        <a href="#home" data-role="button" data-icon="home">Home</a>
        <h4 class="album-title"></h4>
    </div>
</div>

</body>
</html>
